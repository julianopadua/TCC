# üìÑ Documenta√ß√£o do m√≥dulo **`test_usecols_basic.py`**

> **Localiza√ß√£o no projeto**  
> `.venv/Lib/site-packages/pandas/tests/io/parser/usecols/test_usecols_basic.py`  

---

## 1Ô∏è‚É£ Vis√£o geral e responsabilidade  

Este arquivo cont√©m o **conjunto de testes unit√°rios** que validam o comportamento do par√¢metro `usecols` nos parsers CSV/TSV do pandas (`read_csv`, `read_table`, etc.).  
Os testes cobrem:

* Valida√ß√£o de tipos e valores aceitos por `usecols`.  
* Compatibilidade entre `usecols` e outros argumentos (`names`, `header`, `index_col`, `dtype`, `sep`, `delim_whitespace`).  
* Diferentes motores de parsing (`c`, `python`, `pyarrow`) e suas restri√ß√µes espec√≠ficas.  
* Uso de `usecols` como lista, tupla, conjunto, `numpy.ndarray` e **callable**.  
* Cen√°rios de erro (colunas inexistentes, mistura de tipos, √≠ndices fora do intervalo, arquivos com linhas de comprimento desigual, etc.).

O objetivo √© garantir que altera√ß√µes no c√≥digo de parsing n√£o quebrem a API p√∫blica de `usecols` e que mensagens de erro sejam consistentes.

---

## 2Ô∏è‚É£ Onde este arquivo se encaixa na arquitetura  

| Camada | Dom√≠nio | Tipo |
|--------|---------|------|
| **Testes** | I/O ‚Üí Parser CSV/TSV | **Unit‚Äëtest** (pytest) |

O m√≥dulo faz parte da **suite de testes** da biblioteca pandas, localizada em `pandas/tests/io/parser/usecols/`. N√£o cont√©m l√≥gica de produ√ß√£o; serve apenas para validar o c√≥digo em `pandas/io/parsers.py` e nos motores de leitura.

---

## 3Ô∏è‚É£ Interfaces e exports  

O arquivo **n√£o exporta** s√≠mbolos para uso externo. Ele define apenas fun√ß√µes de teste reconhecidas pelo framework **pytest** (`test_*`). Cada fun√ß√£o recebe o fixture `all_parsers`, que representa um objeto capaz de chamar `read_csv` com diferentes motores.

> **Nota:** N√£o h√° `__all__` nem objetos import√°veis; a presen√ßa do m√≥dulo √© detectada automaticamente por `pytest`.

---

## 4Ô∏è‚É£ Depend√™ncias e acoplamentos  

| Depend√™ncia | Tipo | Motivo |
|-------------|------|--------|
| `io.StringIO` | Biblioteca padr√£o | Simula arquivos em mem√≥ria. |
| `numpy` (`np`) | Externa | Utilizado em alguns testes (ex.: `np.array`, `np.nan`). |
| `pytest` | Externa | Framework de teste, marca√ß√µes (`@pytest.mark.parametrize`, `xfail`, `skip`). |
| `pandas.errors.ParserError` | Interna | Verifica exce√ß√µes espec√≠ficas do parser. |
| `pandas` (`DataFrame`, `Index`, `array`) | Interna | Estruturas de dados esperadas nos resultados. |
| `pandas._testing as tm` | Interna | Fun√ß√µes auxiliares de compara√ß√£o (`assert_frame_equal`, `assert_produces_warning`). |

**Acoplamento:** O m√≥dulo depende fortemente da API p√∫blica de `pandas.read_csv` e dos objetos de teste em `pandas._testing`. Qualquer mudan√ßa nesses componentes pode exigir atualiza√ß√£o dos testes.

---

## 5Ô∏è‚É£ Leitura guiada do c√≥digo (top‚Äëdown)

### 5.1 Cabe√ßalho e mensagens de erro

```python
_msg_validate_usecols_arg = (
    "'usecols' must either be list-like "
    "of all strings, all unicode, all "
    "integers or a callable."
)
_msg_validate_usecols_names = (
    "Usecols do not match columns, columns expected but not found: {0}"
)
_msg_pyarrow_requires_names = (
    "The pyarrow engine does not allow 'usecols' to be integer column "
    "positions. Pass a list of string column names instead."
)
```

*Essas strings s√£o reutilizadas em v√°rios `pytest.raises` para garantir mensagens consistentes.*

### 5.2 Marca√ß√£o global de warnings

```python
pytestmark = pytest.mark.filterwarnings(
    "ignore:Passing a BlockManager to DataFrame:DeprecationWarning"
)
```

Silencia warnings de deprecia√ß√£o que n√£o s√£o relevantes para os testes.

### 5.3 Estrutura t√≠pica de um teste

```python
def test_usecols(all_parsers, usecols, request):
    data = """\
a,b,c
1,2,3
4,5,6
7,8,9
10,11,12"""
    parser = all_parsers

    # PyArrow tem restri√ß√£o para √≠ndices inteiros
    if parser.engine == "pyarrow" and isinstance(usecols[0], int):
        with pytest.raises(ValueError, match=_msg_pyarrow_requires_names):
            parser.read_csv(StringIO(data), usecols=usecols)
        return

    result = parser.read_csv(StringIO(data), usecols=usecols)
    expected = DataFrame([[2, 3], [5, 6], [8, 9], [11, 12]], columns=["b", "c"])
    tm.assert_frame_equal(result, expected)
```

*Passos comuns:*
1. **Definir** o CSV de teste (`data`).  
2. **Obter** o parser via fixture `all_parsers`.  
3. **Tratar** casos espec√≠ficos de motor (`pyarrow`).  
4. **Invocar** `read_csv` com `usecols`.  
5. **Construir** o `DataFrame` esperado.  
6. **Comparar** usando `tm.assert_frame_equal`.

### 5.4 Cobertura de cen√°rios

| Cen√°rio | Estrat√©gia de teste | Observa√ß√£o |
|---------|---------------------|------------|
| Tipo inv√°lido (mistura de int e str) | `test_raise_on_mixed_dtype_usecols` | Espera `ValueError` com `_msg_validate_usecols_arg`. |
| `usecols` como **callable** | `test_callable_usecols` | PyArrow rejeita callables; outros motores filtram colunas dinamicamente. |
| `usecols` vazio | `test_empty_usecols` | Verifica DataFrame sem colunas; marcado como `xfail` para PyArrow. |
| Conflito `usecols`‚ÄØ√ó‚ÄØ`index_col` | `test_usecols_index_col_conflict*` | Garante que o √≠ndice selecionado esteja contido em `usecols`. |
| Separador regex / `delim_whitespace` | `test_usecols_regex_sep`, `test_usecols_with_whitespace` | PyArrow n√£o suporta; outros motores emitem `FutureWarning`. |
| Colunas adicionais no arquivo | `test_usecols_additional_columns*` | Verifica que colunas n√£o solicitadas s√£o ignoradas. |
| `dtype` espec√≠fico | `test_usecols_dtype` | Confirma que tipos declarados s√£o preservados nas colunas selecionadas. |
| Linhas de comprimento desigual | `test_uneven_length_cols` | Garante que o parser preencha `NaN` quando necess√°rio. |
| √çndices fora do intervalo | `test_usecols_indices_out_of_bounds` | Espera `ParserError` (ou `ValueError` no PyArrow). |

---

## 6Ô∏è‚É£ Fluxo de dados / estado / eventos  

1. **Entrada** ‚Äì String CSV (`StringIO`).  
2. **Par√¢metro** ‚Äì `usecols` (list, tuple, set, ndarray, callable).  
3. **Processamento** ‚Äì `parser.read_csv` (delegado ao motor escolhido).  
4. **Sa√≠da** ‚Äì `DataFrame` contendo **apenas** as colunas especificadas.  
5. **Valida√ß√£o** ‚Äì `tm.assert_frame_equal` compara estrutura, tipos e valores.  

N√£o h√° estado persistente entre testes; cada fun√ß√£o cria seu pr√≥prio ambiente isolado.

---

## 7Ô∏è‚É£ Conex√µes com outros arquivos do projeto  

| Arquivo | Tipo de v√≠nculo | Coment√°rio |
|---------|----------------|------------|
| `pandas/tests/io/parser/parsers.py` | **Fixture** (`all_parsers`) | Fornece objetos que encapsulam diferentes motores (`c`, `python`, `pyarrow`). |
| `pandas/io/parsers.py` | **C√≥digo sob teste** | Implementa a l√≥gica de `usecols` que estes testes exercitam. |
| `pandas/_testing.py` | **Utilit√°rio** | Fun√ß√µes de compara√ß√£o e captura de warnings. |
| `pandas/errors.py` | **Exce√ß√µes** | Classe `ParserError` usada nos asserts. |

> **Links**: (n√£o dispon√≠veis no contexto; referenciar a documenta√ß√£o oficial do pandas quando necess√°rio).

---

## 8Ô∏è‚É£ Pontos de aten√ß√£o, riscos e melhorias recomendadas  

| Item | Impacto | Recomenda√ß√µes |
|------|---------|---------------|
| **Depend√™ncia de `pyarrow`** | Alguns testes s√£o marcados como `xfail`/`skip` porque o motor ainda n√£o suporta certas funcionalidades (`usecols` como callable, √≠ndices inteiros, regex separator). | Atualizar a suite quando o suporte for implementado; remover marca√ß√µes obsoletas. |
| **Mensagens de erro hard‚Äëcoded** | Altera√ß√µes nas mensagens de valida√ß√£o podem quebrar m√∫ltiplos testes. | Centralizar mensagens em constantes (j√° feito) e garantir que a API p√∫blica as exponha, ou usar regex mais flex√≠vel nos asserts. |
| **Cobertura de tipos de dados** | Testes atuais cobrem `int`, `str`, `uint8`, `string`, mas n√£o tipos complexos (datetime, categorical). | Incluir casos que combinam `usecols` com `parse_dates`, `categorical` e `dtype` avan√ßados. |
| **Performance** | Cada teste cria um `StringIO` pequeno; n√£o h√° impacto real, mas a cria√ß√£o repetida pode ser evitada usando fixtures de dados. | Criar fixtures reutiliz√°veis para CSVs comuns. |
| **Manuten√ß√£o de fixtures** | O fixture `all_parsers` pode mudar de assinatura. | Documentar explicitamente a interface esperada (`read_csv` + atributo `engine`). |
| **Uso de `skip_pyarrow` / `xfail_pyarrow`** | Dependem de nomes de fixtures externos; se forem renomeados, os testes falhar√£o silenciosamente. | Verificar a exist√™ncia das fixtures no `conftest.py` e atualizar nomes se necess√°rio. |

--- 

*Esta documenta√ß√£o foi gerada a partir da an√°lise est√°tica do c√≥digo-fonte e reflete o comportamento observado nos testes atuais. Qualquer altera√ß√£o na API de `read_csv` ou nos motores de parsing pode requerer revis√£o desta documenta√ß√£o.*
