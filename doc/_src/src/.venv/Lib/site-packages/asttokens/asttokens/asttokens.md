# üìÑ Documenta√ß√£o interna ‚Äì `asttokens/asttokens.py`

---

## 1. Vis√£o geral e responsabilidade

Este m√≥dulo fornece duas classes principais que permitem **mapear trechos de c√≥digo-fonte Python para n√≥s da √Årvore Sint√°tica Abstrata (AST)** e vice‚Äëversa:

| Classe | Responsabilidade |
|--------|-------------------|
| **`ASTTextBase`** (abstrata) | Mant√©m o texto original, a estrutura de linhas (`LineNumbers`) e define a API de consulta de posi√ß√µes e textos de n√≥s AST. |
| **`ASTTokens`** | Extende `ASTTextBase` adicionando **tokeniza√ß√£o** completa (via `tokenize`), indexa√ß√£o por offset e marca√ß√£o de n√≥s AST com atributos `.first_token` / `.last_token`. |
| **`ASTText`** | Implementa a mesma API de `ASTTokens` **sem usar tokens** (quando suportado), delegando a `ASTTokens` apenas nos casos em que a estrat√©gia ‚Äútoken‚Äëless‚Äù falha. |

O objetivo central √© **expor, de forma consistente e eficiente, a correspond√™ncia entre texto e AST**, permitindo:

* obten√ß√£o de **segmentos de c√≥digo** (`get_text`, `get_text_range`);
* localiza√ß√£o de **tokens** a partir de posi√ß√µes de linha/coluna ou offset;
* navega√ß√£o entre tokens (`next_token`, `prev_token`, `find_token`);
* suporte a **f‚Äëstrings** e a √°rvores produzidas por `ast` ou `astroid`.

---

## 2. Onde este arquivo se encaixa na arquitetura

| Camada / Dom√≠nio | Papel |
|------------------|-------|
| **Utilit√°rio / Core** | Fornece servi√ßos de an√°lise est√°tica reutiliz√°veis por ferramentas de lint, refatora√ß√£o, depura√ß√£o e gera√ß√£o de c√≥digo. |
| **Depend√™ncia de n√≠vel baixo** | N√£o depende de UI, nem de camada de aplica√ß√£o; apenas da biblioteca padr√£o (`ast`, `tokenize`, `bisect`) e de m√≥dulos internos (`line_numbers`, `util`, `mark_tokens`). |
| **Ponto de integra√ß√£o** | √â consumido por m√≥dulos que precisam de **informa√ß√£o de origem** (ex.: `asttokens/mark_tokens.py`, `asttokens/util.py`). |

---

## 3. Interfaces e exports (o que ele exp√µe)

```python
# Exportados pelo m√≥dulo
__all__ = [
    "ASTTextBase",
    "ASTTokens",
    "ASTText",
    "supports_tokenless",
]
```

### Principais m√©todos p√∫blicos

| Classe | M√©todo | Descri√ß√£o |
|--------|--------|-----------|
| `ASTTextBase` | `get_text_positions(node, padded)` | **Abstrato** ‚Äì devolve tuplas `(lineno, col_offset)` de in√≠cio/fim. |
| `ASTTextBase` | `get_text_range(node, padded=True)` | Converte posi√ß√µes em **offsets** de texto. |
| `ASTTextBase` | `get_text(node, padded=True)` | Retorna o **segmento de c√≥digo** correspondente ao n√≥. |
| `ASTTokens` | `__init__(source_text, parse=False, tree=None, ...)` | Cria a estrutura, opcionalmente parseia o c√≥digo e marca tokens. |
| `ASTTokens` | `mark_tokens(root_node)` | Marca a √°rvore AST com tokens (delegado a `MarkTokens`). |
| `ASTTokens` | `get_token(lineno, col_offset)` / `get_token_from_offset(offset)` | Busca token contendo a posi√ß√£o indicada. |
| `ASTTokens` | `next_token`, `prev_token`, `find_token`, `token_range`, `get_tokens` | Navega√ß√£o e filtragem de tokens. |
| `ASTTokens` | `get_text_positions(node, padded)` | Implementa√ß√£o baseada em tokens. |
| `ASTText` | `tree` (property) | Gera/retorna a √°rvore AST (lazy). |
| `ASTText` | `asttokens` (property) | Instancia `ASTTokens` sob demanda. |
| `ASTText` | `_get_text_positions_tokenless(node, padded)` | Estrat√©gia ‚Äútoken‚Äëless‚Äù. |
| `ASTText` | `get_text_positions(node, padded)` | Decide entre token‚Äëless ou delega a `ASTTokens`. |
| m√≥dulo | `supports_tokenless(node=None)` | Indica se a estrat√©gia token‚Äëless √© v√°lida para o n√≥/vers√£o corrente. |

---

## 4. Depend√™ncias e acoplamentos

| Tipo | M√≥dulo | Motivo |
|------|--------|--------|
| **Externa (stdlib)** | `abc`, `ast`, `bisect`, `sys`, `token`, `typing` | Implementa√ß√£o de abstra√ß√µes, parsing, busca bin√°ria, introspec√ß√£o de vers√£o e tipagem. |
| **Interna** | `line_numbers.LineNumbers` | Convers√£o entre linhas/colunas e offsets. |
| **Interna** | `util` (fun√ß√µes e tipos) | Manipula√ß√£o de tokens, detec√ß√£o de tokens n√£o‚Äëc√≥digo, gera√ß√£o de tokens, anota√ß√£o de f‚Äëstrings, utilit√°rios de AST. |
| **Interna (lazy)** | `mark_tokens.MarkTokens` | Marca a √°rvore AST com tokens; importado dentro de `mark_tokens` para evitar ciclos. |
| **Tipo‚Äëchecking only** | `util.AstNode`, `util.TokenInfo` | Dispon√≠veis apenas em tempo de verifica√ß√£o est√°tica (`TYPE_CHECKING`). |

**Acoplamento**: O m√≥dulo depende fortemente de `LineNumbers` e de utilit√°rios de tokeniza√ß√£o; mudan√ßas nesses componentes podem impactar a precis√£o de offsets e a l√≥gica de `padded`.

---

## 5. Leitura guiada do c√≥digo (top‚Äëdown)

### 5.1. Defini√ß√µes iniciais

```python
class ASTTextBase(metaclass=abc.ABCMeta):
    def __init__(self, source_text: str, filename: str) -> None:
        self._filename = filename
        self._text = str(source_text)          # garante str (compatibilidade Py2)
        self._line_numbers = LineNumbers(source_text)
```

* **Invariante**: `_text` e `_line_numbers` permanecem imut√°veis ap√≥s a constru√ß√£o.
* **Decis√£o**: Converte `source_text` para `str` imediatamente para lidar com declara√ß√µes de codifica√ß√£o (Python¬†2 legacy).

### 5.2. API de posi√ß√£o e texto (classe base)

* `get_text_positions` ‚Äì **abstrato**, implementado nas subclasses.
* `get_text_range` ‚Äì converte posi√ß√µes de linha/coluna para offsets usando `LineNumbers`.
* `get_text` ‚Äì fatia `_text` com os offsets obtidos.

### 5.3. `ASTTokens`

#### Construtor

```python
def __init__(self, source_text, parse=False, tree=None,
             filename='<unknown>', tokens=None):
    super(ASTTokens, self).__init__(source_text, filename)
    self._tree = ast.parse(source_text, filename) if parse else tree
    if tokens is None:
        tokens = generate_tokens(self._text)
    self._tokens = list(self._translate_tokens(tokens))
    self._token_offsets = [tok.startpos for tok in self._tokens]
    if self._tree:
        self.mark_tokens(self._tree)
```

* **Decis√£o**: aceita *source* j√° tokenizado (`tokens`) para testes ou otimiza√ß√µes.
* **Invariante**: `_token_offsets` est√° sempre ordenado, permitindo busca bin√°ria (`bisect`).

#### Tradu√ß√£o de tokens

```python
def _translate_tokens(self, original_tokens):
    for index, tok in enumerate(patched_generate_tokens(original_tokens)):
        tok_type, tok_str, start, end, line = tok
        yield Token(
            tok_type, tok_str, start, end, line, index,
            self._line_numbers.line_to_offset(start[0], start[1]),
            self._line_numbers.line_to_offset(end[0], end[1]),
        )
```

* Converte tokens da biblioteca padr√£o para a classe interna `Token`, adicionando **offsets pr√©‚Äëcalculados**.

#### Navega√ß√£o e busca

* `get_token_from_offset` usa `bisect` para localizar o token que cont√©m o offset.
* `next_token` / `prev_token` podem **ignorar tokens n√£o‚Äëc√≥digo** (`NL`, `COMMENT`) a menos que `include_extra=True`.
* `find_token` percorre a sequ√™ncia (ou retrocede) at√© encontrar o tipo e, opcionalmente, o texto desejado.

#### Posicionamento baseado em tokens

```python
def get_text_positions(self, node, padded):
    if not hasattr(node, 'first_token'):
        return (1, 0), (1, 0)
    start = node.first_token.start
    end = node.last_token.end
    if padded and any(match_token(t, token.NEWLINE) for t in self.get_tokens(node)):
        start = (start[0], 0)   # inclui indenta√ß√£o inicial
    return start, end
```

* **Regra de ‚Äúpadded‚Äù**: quando o n√≥ ocupa m√∫ltiplas linhas, o in√≠cio √© ajustado para a coluna‚ÄØ0, reproduzindo o comportamento de `ast.get_source_segment(padded=True)`.

### 5.4. `ASTText`

* Implementa a mesma API, mas tenta **evitar tokeniza√ß√£o** (mais r√°pido) usando apenas informa√ß√µes de linha/coluna do pr√≥prio AST.
* Quando o n√≥ n√£o √© suportado (`supports_tokenless` retorna `False`) delega a `ASTTokens` (lazy, via propriedade `asttokens`).

#### Estrat√©gia token‚Äëless

```python
def _get_text_positions_tokenless(self, node, padded):
    if is_module(node):
        return (1, 0), self._line_numbers.offset_to_line(len(self._text))
    if getattr(node, 'lineno', None) is None:
        return (1, 0), (1, 0)
    # tratamento de decoradores, docstrings, etc.
    ...
    return start, end
```

* **Decis√£o**: para defini√ß√µes com decoradores, o in√≠cio √© o primeiro decorador, n√£o a palavra‚Äëchave `def`/`class`.
* **Ajuste de ‚Äúpadded‚Äù**: similar ao algoritmo token‚Äëbased, mas verifica diferen√ßas de linha entre `start_lineno` e `end_node.lineno`.

### 5.5. Fun√ß√£o `supports_tokenless`

* Verifica **vers√£o do Python**, **tipo de n√≥** e **ambiente (PyPy)**.
* Mant√©m lista `_unsupported_tokenless_types` que inclui n√≥s que n√£o possuem `lineno` ou que apresentam bugs conhecidos (ex.: Python‚ÄØ3.8).

---

## 6. Fluxo de dados / estado / eventos

1. **Entrada**: `source_text` (string ou bytes UTF‚Äë8) + opcionalmente `tree` ou `tokens`.
2. **Constru√ß√£o**:
   * `ASTTextBase` armazena o texto e cria `LineNumbers`.
   * `ASTTokens` (se usado) gera tokens, calcula offsets e preenche `_token_offsets`.
   * Opcionalmente, `mark_tokens` associa tokens a n√≥s AST.
3. **Consultas**:
   * Chamadas a `get_text`, `get_text_range` ou `get_text_positions` percorrem:
     - Se `ASTTokens` est√° presente ‚Üí usa atributos `.first_token/.last_token`.
     - Caso contr√°rio ‚Üí usa l√≥gica token‚Äëless (`ASTText._get_text_positions_tokenless`).
4. **Estado interno**:
   * Imut√°vel ap√≥s a constru√ß√£o (texto, tokens, offsets, √°rvore).
   * Lazy‚Äëinitialization de `ASTTokens` dentro de `ASTText` (primeira chamada que requer tokens).

N√£o h√° **eventos** externos; o m√≥dulo √© puramente funcional.

---

## 7. Conex√µes com outros arquivos do projeto

| M√≥dulo | Tipo de rela√ß√£o | Coment√°rio |
|--------|----------------|------------|
| `asttokens/line_numbers.py` | **Importa√ß√£o** (`LineNumbers`) | Converte linhas/colunas ‚ÜîÔ∏é offsets. |
| `asttokens/util.py` | **Importa√ß√£o** (fun√ß√µes e tipos) | Gera tokens, identifica tokens n√£o‚Äëc√≥digo, anota f‚Äëstrings, etc. |
| `asttokens/mark_tokens.py` | **Importa√ß√£o tardia** (`MarkTokens`) | Marca a √°rvore AST com tokens; importado dentro de `mark_tokens` para evitar ciclos. |
| `asttokens/__init__.py` | **Re‚Äëexport** | Provavelmente exp√µe `ASTTokens`, `ASTText`, `supports_tokenless` para usu√°rios externos. |
| **Nenhum** | **Exportado** para outros m√≥dulos externos (n√£o h√° imports externos adicionais). |

> **Observa√ß√£o**: os links reais para a documenta√ß√£o interna n√£o foram fornecidos; substitua pelos caminhos corretos ao integrar a documenta√ß√£o.

---

## 8. Pontos de aten√ß√£o, riscos e melhorias recomendadas

| √Årea | Risco / Limita√ß√£o | Recomenda√ß√µes |
|------|-------------------|---------------|
| **Compatibilidade de vers√µes** | Lista `_unsupported_tokenless_types` fixa; novos tipos ou mudan√ßas em vers√µes futuras podem quebrar `supports_tokenless`. | Automatizar a detec√ß√£o de n√≥s sem `lineno` via introspec√ß√£o ao inv√©s de lista est√°tica. |
| **Ambiente PyPy** | `supports_tokenless` desabilita a estrat√©gia token‚Äëless em PyPy, mas n√£o h√° fallback expl√≠cito para `ASTTokens`. | Documentar claramente o comportamento esperado em PyPy e, se necess√°rio, for√ßar a cria√ß√£o de `ASTTokens`. |
| **Performance da tokeniza√ß√£o** | `ASTTokens.__init__` sempre gera a lista completa de tokens, mesmo que o usu√°rio s√≥ precise de algumas consultas. | Implementar tokeniza√ß√£o **lazy** (gerador) ou cache parcial baseado em demanda. |
| **Manuten√ß√£o de offsets** | Offsets s√£o calculados uma √∫nica vez; altera√ß√µes posteriores ao texto (ex.: edi√ß√£o) n√£o s√£o refletidas. | Deixar expl√≠cito que a classe √© **imut√°vel**; caso seja necess√°rio suporte a edi√ß√£o, criar uma camada de ‚Äúmutable ASTTokens‚Äù. |
| **F‚Äëstrings** | Anota√ß√£o de n√≥s dentro de f‚Äëstrings pode marcar `_broken_positions`; o fallback devolve `(1,0)`. | Avaliar se √© poss√≠vel melhorar a precis√£o da anota√ß√£o ou expor um modo ‚Äúbest‚Äëeffort‚Äù. |
| **Test coverage** | Coment√°rios `# TODO` indicam lacunas (ex.: teste de multibyte Unicode). | Adicionar testes unit√°rios que cobrem offsets UTF‚Äë8 vs. Unicode, especialmente para caracteres multibyte. |
| **Documenta√ß√£o de API** | M√©todos p√∫blicos n√£o t√™m docstrings completas (ex.: `next_token`, `prev_token`). | Expandir docstrings, incluindo exemplos de uso e limites (ex.: comportamento em fim de arquivo). |

--- 

*Esta documenta√ß√£o segue as diretrizes solicitadas: escrita em portugu√™s brasileiro, tom t√©cnico, estrutura em Markdown com se√ß√µes claras e blocos de c√≥digo limitados a 8 trechos de at√© 80 linhas.*
