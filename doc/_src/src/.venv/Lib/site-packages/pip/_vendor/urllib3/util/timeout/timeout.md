# 1. Visão geral e responsabilidade  

O módulo **`urllib3.util.timeout`** define a classe **`Timeout`**, que encapsula a configuração de tempos‑limite (timeout) para conexões HTTP.  
Ele oferece:

* Representação explícita de três tipos de timeout – **total**, **connect** e **read**.  
* Validação rigorosa dos valores recebidos (tipo, sinal, limites).  
* Cálculo dinâmico do timeout de leitura quando o timeout total está definido.  
* Controle de estado interno para medir o tempo gasto na fase de conexão.  

Essas funcionalidades permitem que o restante da pilha `urllib3` (gerenciadores de conexão, pools e adaptadores HTTP) aplique políticas de timeout de forma consistente e previsível.

---

# 2. Onde este arquivo se encaixa na arquitetura  

| Camada | Módulo / Pacote | Função |
|--------|-----------------|--------|
| **Utilitários / Infra‑estrutura** | `urllib3.util.timeout` | Fornece um objeto de configuração reutilizável para controle de tempo‑limite em toda a biblioteca. |
| **Domínio** | Não se aplica diretamente a domínio de negócio; é um componente de suporte ao cliente HTTP. |
| **UI / API pública** | Exposto via `urllib3.util.timeout.Timeout` e, indiretamente, através de parâmetros `timeout` de `PoolManager`, `HTTPConnectionPool`, etc. |

---

# 3. Interfaces e exports  

| Nome | Tipo | Descrição |
|------|------|-----------|
| `Timeout` | **classe** | Principal API pública. Construtor `Timeout(total=None, connect=_Default, read=_Default)`. |
| `_Default` | **sentinela** | Valor interno usado para distinguir “não especificado” de “valor padrão do socket”. Não faz parte da API pública, mas pode ser importado por código que precise replicar o comportamento interno. |
| `current_time` | **função** | Alias para `time.monotonic` (quando disponível) ou `time.time`. Utilizado internamente para medir intervalos. |
| `Timeout.DEFAULT_TIMEOUT` | **atributo de classe** | Expondo o sentinel `_GLOBAL_DEFAULT_TIMEOUT` do módulo `socket`. Representa “usar o timeout padrão do sistema”. |

> **Exportação implícita** – o módulo não define `__all__`; portanto, tudo que não começa com “_” está disponível para importação (`from urllib3.util.timeout import Timeout`).

---

# 4. Dependências e acoplamentos  

| Tipo | Módulo | Motivo |
|------|--------|--------|
| **Externa (stdlib)** | `time` | Funções de relógio (`time.monotonic` / `time.time`). |
| **Externa (stdlib)** | `socket._GLOBAL_DEFAULT_TIMEOUT`, `socket.getdefaulttimeout` | Sentinel e função para obter o timeout padrão do interpretador. |
| **Interna (urllib3)** | `urllib3.exceptions.TimeoutStateError` | Exceção específica lançada quando o estado interno do timer é inconsistente. |
| **Interna (urllib3)** | Nenhum outro módulo importado diretamente. |

Acoplamento: **Baixo** – a classe depende apenas de tipos e funções da biblioteca padrão e de uma exceção de domínio próprio. Não há dependência circular.

---

# 5. Leitura guiada do código (top‑down)

1. **Sentinela `_Default`** – objeto único usado para diferenciar parâmetros omitidos (`connect=_Default`) do valor explícito `None` ou do sentinel de socket.  
2. **`current_time`** – resolve, em tempo de importação, a função de relógio mais adequada (`monotonic` se existir, caso contrário `time`). Garante que medições de intervalo não sejam afetadas por ajustes de relógio.  
3. **Classe `Timeout`**  
   * **Constantes** – `DEFAULT_TIMEOUT` aponta para `_GLOBAL_DEFAULT_TIMEOUT`.  
   * **`__init__`** – valida e armazena os valores de `total`, `connect` e `read` usando `_validate_timeout`. O atributo `_start_connect` inicia como `None`.  
   * **`__repr__` / `__str__`** – representação legível para depuração.  
   * **`resolve_default_timeout` (classmethod)** – converte o sentinel `DEFAULT_TIMEOUT` no valor real retornado por `socket.getdefaulttimeout()`.  
   * **`_validate_timeout` (classmethod)** – garante que o valor seja `None`, o sentinel de socket ou um número positivo (int/float). Lança `ValueError` para booleanos, tipos incompatíveis ou valores ≤ 0.  
   * **`from_float` (classmethod)** – cria um `Timeout` compatível com a API legada que usava um único timeout para conexão e leitura.  
   * **`clone`** – devolve uma nova instância com os mesmos parâmetros, evitando `deepcopy` que poderia duplicar o sentinel de socket.  
   * **`start_connect`** – registra o instante de início da tentativa de conexão (`_start_connect`). Levanta `TimeoutStateError` se já houver um registro.  
   * **`get_connect_duration`** – calcula o tempo decorrido desde `start_connect`. Levanta `TimeoutStateError` se ainda não houver início.  
   * **`connect_timeout` (property)** – devolve o timeout efetivo a ser usado na chamada `socket.connect`. Se `total` estiver definido, ele pode sobrescrever `connect` (menor dos dois).  
   * **`read_timeout` (property)** – devolve o timeout de leitura, levando em conta o tempo já consumido na fase de conexão quando `total` está definido. Se o timer de conexão ainda não foi iniciado, retorna o valor bruto de `_read`.  

**Decisões de implementação relevantes**

* **Uso de sentinel `_Default`** – permite distinguir “não especificado” de “valor explícito `None`”.  
* **Medição com `monotonic`** – evita erros quando o relógio do sistema é alterado.  
* **Cálculo de `read_timeout`** – garante que o tempo total não seja excedido, retornando `max(0, …)` para evitar valores negativos.  
* **Exceções específicas (`TimeoutStateError`)** – facilitam a detecção de uso incorreto da API (ex.: chamar `read_timeout` antes de iniciar a contagem).

---

# 6. Fluxo de dados/estado/eventos  

| Evento / Operação | Estado interno afetado | Resultado |
|-------------------|------------------------|-----------|
| Instanciação `Timeout(...)` | `_connect`, `_read`, `total` são validados e armazenados. `_start_connect = None`. | Objeto configurado. |
| `start_connect()` | `_start_connect` recebe `current_time()`. | Marca início da fase de conexão. |
| `get_connect_duration()` | Lê `_start_connect`. | Retorna tempo decorrido (float). |
| Acesso a `connect_timeout` | Nenhum. | Calcula valor efetivo com base em `total` e `_connect`. |
| Acesso a `read_timeout` | Pode ler `_start_connect` (se `total` definido). | Calcula timeout restante ou devolve `_read`. |
| `clone()` | Cria novo objeto com mesmos parâmetros, sem copiar `_start_connect`. | Instância independente. |

O objeto **não** gera eventos externos; ele apenas mantém estado interno de temporização.

---

# 7. Conexões com outros arquivos do projeto  

| Módulo que importa | Motivo da importação |
|--------------------|----------------------|
| *(nenhum listado nas metainformações)* | Não há referências explícitas neste snapshot. Contudo, a documentação oficial indica que `Timeout` é usado por `urllib3.poolmanager.PoolManager`, `urllib3.connectionpool.HTTPConnectionPool` e adaptadores de transporte. |
| **Referência externa** | `urllib3.exceptions.TimeoutStateError` – definido em `urllib3.exceptions`. |

> **Nota:** Como o repositório não fornece links de importação, os caminhos exatos não podem ser inferidos aqui. Recomenda‑se buscar por `from urllib3.util.timeout import Timeout` no código‑fonte para localizar os consumidores.

---

# 8. Pontos de atenção, riscos e melhorias recomendadas  

| Item | Impacto | Recomendações |
|------|---------|---------------|
| **Validação de tipos** – aceita `bool` como subclasse de `int` e rejeita explicitamente. | Evita comportamentos inesperados (`True` → 1). | Mantido; documentação clara. |
| **Uso de `float(value)`** – pode converter objetos que implementam `__float__` de forma inesperada. | Risco baixo, mas pode introduzir dependências implícitas. | Documentar que objetos customizados com `__float__` são aceitos. |
| **`read_timeout`** – retorna `max(0, …)` podendo gerar timeout zero, que pode ser interpretado como “sem espera”. | Pode levar a falhas rápidas se o código cliente não tratar timeout zero. | Considerar lançar `TimeoutStateError` quando o cálculo resultar em zero, ou documentar explicitamente o comportamento. |
| **Ausência de `__all__`** – exporta internamente `_Default` e `current_time`. | Usuários podem importar acidentalmente símbolos internos. | Definir `__all__ = ["Timeout"]` para limitar a API pública. |
| **Compatibilidade com Python < 3.3** – `time.monotonic` pode não existir. O fallback para `time.time` pode ser afetado por ajustes de relógio. | Em ambientes legados, medições podem ser imprecisas. | Avaliar uso de `time.perf_counter` como alternativa mais robusta. |
| **Documentação de `DEFAULT_TIMEOUT`** – expõe sentinel de `socket`, mas não descreve como o usuário deve utilizá‑lo. | Pode gerar confusão ao tentar passar o sentinel diretamente. | Incluir exemplo de uso de `Timeout.DEFAULT_TIMEOUT` na docstring. |

Implementar as melhorias acima aumentará a robustez da API e reduzirá a superfície de uso indevido.
